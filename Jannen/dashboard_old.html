<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charge Consensus Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 24px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container { max-width: 1400px; margin: auto; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }
        h1 { color: #ffffff; font-weight: 700; margin: 0; }
        .grid-controls button {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .grid-controls button:hover { background-color: #3a3a3a; border-color: #666; }
        .grid-controls button.active { color: #ffffff; font-weight: 600; }
        #stabilize-btn.active { border-color: #388E3C; box-shadow: 0 0 8px rgba(56, 142, 60, 0.5); }
        #stress-btn.active { border-color: #D32F2F; box-shadow: 0 0 8px rgba(211, 47, 47, 0.5); }
        .grid-status {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 32px;
            font-size: 1.5em;
            font-weight: 600;
            text-align: center;
            color: white;
            transition: background-color 0.5s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .stressed { background: linear-gradient(90deg, #D32F2F, #B71C1C); }
        .stable { background: linear-gradient(90deg, #388E3C, #1B5E20); }
        h2 { color: #bbbbbb; border-bottom: 1px solid #333; padding-bottom: 10px; font-weight: 600; }
        .queue { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 24px; }
        .car {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }
        .car:hover { transform: translateY(-5px); border-color: #555; }
        .car h3 { margin-top: 0; color: #ffffff; font-size: 1.2em; display: flex; align-items: center; gap: 10px; }
        .priority-high { border-left: 6px solid #D32F2F; }
        .priority-medium { border-left: 6px solid #FBC02D; }
        .priority-low { border-left: 6px solid #388E3C; }
        .car p { margin: 8px 0; line-height: 1.6; color: #cccccc; }
        .car strong { color: #9e9e9e; font-weight: 500; }
        .time-remaining { font-weight: bold; font-size: 1.2em; }
        .time-high { color: #FFB74D; }
        .time-medium { color: #64B5F6; }
        .time-low { color: #81C784; }
        .points { font-weight: 600; color: #64B5F6; font-size: 1.1em; }
        .option-eco { color: #81C784; font-weight: 600; }
        .option-fast { color: #FFB74D; font-weight: 600; }
        .request-text { font-style: italic; color: #9e9e9e; background-color: #2a2a2a; padding: 12px; border-radius: 8px; margin-top: auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>Charge Consensus Dashboard</h1><div class="grid-controls"><button id="stabilize-btn" onclick="setGridStatus(false)">Set Grid to STABLE</button><button id="stress-btn" onclick="setGridStatus(true)">Set Grid to STRESSED</button></div></div>
        <div id="grid-status" class="grid-status stable">Grid Status: STABLE</div>
        <h2>Charging Queue (<span id="queue-count">0</span> cars)</h2>
        <div id="charging-queue" class="queue"></div>
    </div>
    <script>
        function calculateTimeRemaining(pickupTime) {
            if (!pickupTime || !pickupTime.includes(':')) return 'Calculating...';
            const now = new Date();
            const [hours, minutes] = pickupTime.split(':').map(Number);
            let pickup = new Date();
            pickup.setHours(hours, minutes, 0, 0);
            if (pickup < now) { pickup.setDate(pickup.getDate() + 1); }
            const diffMs = pickup - now;
            if (diffMs <= 0) return 'Ready for Pickup!';
            const diffHours = Math.floor(diffMs / 3600000);
            const diffMins = Math.floor((diffMs % 3600000) / 60000);
            let timeString = '';
            if (diffHours > 0) timeString += `${diffHours}h `;
            timeString += `${diffMins}m`;
            return timeString;
        }

        async function setGridStatus(isStressed) {
            const endpoint = isStressed ? '/api/grid/stress' : '/api/grid/stabilize';
            try { await fetch(`http://127.0.0.1:8001${endpoint}`, { method: 'POST' }); fetchData(); } catch (error) { console.error('Failed to set grid status:', error); }
        }

        async function fetchData() {
            try {
                const response = await fetch('http://127.0.0.1:8001/api/status');
                if (!response.ok) throw new Error(`Network error: ${response.status}`);
                const data = await response.json();
                const queueDiv = document.getElementById('charging-queue'), queueCountSpan = document.getElementById('queue-count'), gridStatusDiv = document.getElementById('grid-status'), stabilizeBtn = document.getElementById('stabilize-btn'), stressBtn = document.getElementById('stress-btn');
                queueDiv.innerHTML = '', queueCountSpan.textContent = data.chargers_in_use, gridStatusDiv.textContent = `Grid Status: ${data.is_grid_stressed ? 'STRESSED' : 'STABLE'}`, gridStatusDiv.className = `grid-status ${data.is_grid_stressed ? 'stressed' : 'stable'}`, stabilizeBtn.classList.toggle('active', !data.is_grid_stressed), stressBtn.classList.toggle('active', data.is_grid_stressed);
                if (data.priority_queue.length === 0) { queueDiv.innerHTML = '<p>No cars in the charging queue.</p>'; } else {
                    data.priority_queue.forEach(car => {
                        const carDiv = document.createElement('div'), driverName = car.user_did.split(':').slice(-2, -1)[0] || 'Unknown', chargingPlan = car.charging_option ? car.charging_option.replace('_', ' ').toUpperCase() : 'Deciding...', chargingPlanClass = car.charging_option === 'eco_charge' ? 'eco' : 'fast';
                        const timeRemaining = calculateTimeRemaining(car.pickup_time);
                        let timeClass = 'time-low';
                        if (timeRemaining.includes('h') && parseInt(timeRemaining) < 2) timeClass = 'time-medium';
                        if (!timeRemaining.includes('h') && parseInt(timeRemaining) < 60) timeClass = 'time-high';
                        if (timeRemaining === 'Ready for Pickup!') timeClass = 'time-low';
                        carDiv.className = `car priority-${car.priority}`, carDiv.innerHTML = `<h3><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5H15V3H9V5H6.5C5.84 5 5.28 5.42 5.08 6.01L3 12V20C3 20.55 3.45 21 4 21H5C5.55 21 6 20.55 6 20V19H18V20C18 20.55 18.45 21 19 21H20C20.55 21 21 20.55 21 20V12L18.92 6.01ZM6.85 7H17.14L18.36 10H5.64L6.85 7ZM19 17H5V12H19V17Z"/></svg> Driver: ${driverName.charAt(0).toUpperCase() + driverName.slice(1)}</h3><p><strong>Priority:</strong> ${car.priority.toUpperCase()}</p><p><strong>SoC:</strong> ${car.start_soc}% &rarr; ${car.min_soc || 'N/A'}%</p><p class="time-remaining ${timeClass}"><strong>Ready In:</strong> ${timeRemaining}</p><p class="option-${chargingPlanClass}"><strong>Charging Plan:</strong> ${chargingPlan}</p><p class="points"><strong>Loyalty Points:</strong> ${car.points_awarded || 0} âœ¨</p><p class="request-text">"${car.original_text}"</p>`;
                        queueDiv.appendChild(carDiv);
                    });
                }
            } catch (error) { console.error('Failed to fetch data:', error); document.getElementById('charging-queue').innerHTML = '<p style="color: #D32F2F;">Error loading data. Is the orchestrator script running?</p>'; }
        }
        setInterval(fetchData, 2000); window.onload = fetchData;
    </script>
</body>
</html>
