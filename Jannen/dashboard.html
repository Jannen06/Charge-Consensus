<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChargeFlex AI Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        h1, h2 { color: #1a73e8; }
        .grid-status { padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 1.2em; text-align: center; color: white; }
        .stressed { background-color: #d93025; }
        .stable { background-color: #1e8e3e; }
        .queue { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .car { background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 20px; transition: all 0.3s ease; }
        .car:hover { transform: translateY(-5px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .car h3 { margin-top: 0; color: #333; }
        .priority-high { border-left: 5px solid #d93025; }
        .priority-medium { border-left: 5px solid #f9ab00; }
        .priority-low { border-left: 5px solid #1e8e3e; }
        .car p { margin: 5px 0; }
        .points { font-weight: bold; color: #1a73e8; }
        .option { font-style: italic; color: #5f6368; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Charge Consensus Dashboard</h1>
        <div id="grid-status" class="grid-status stable">Grid Status: STABLE</div>
        <h2>Charging Queue (<span id="queue-count">0</span> cars)</h2>
        <div id="charging-queue" class="queue"></div>
    </div>

    <script>
        async function fetchData() {
            try {
                const response = await fetch('http://127.0.0.1:8001/api/status');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                const queueDiv = document.getElementById('charging-queue');
                const queueCountSpan = document.getElementById('queue-count');
                const gridStatusDiv = document.getElementById('grid-status');

                queueDiv.innerHTML = ''; // Clear the current queue
                queueCountSpan.textContent = data.chargers_in_use;
                
                // Simulate grid status changing
                const isStressed = Math.random() > 0.5;
                gridStatusDiv.textContent = `Grid Status: ${isStressed ? 'STRESSED' : 'STABLE'}`;
                gridStatusDiv.className = `grid-status ${isStressed ? 'stressed' : 'stable'}`;

                if (data.priority_queue.length === 0) {
                    queueDiv.innerHTML = '<p>No cars in the charging queue.</p>';
                } else {
                    data.priority_queue.forEach(car => {
                        const carDiv = document.createElement('div');
                        carDiv.className = `car priority-${car.priority}`;
                        
                        carDiv.innerHTML = `
                            <h3>Driver: ${car.user_did.split(':').slice(-2, -1)[0] || 'Unknown'}</h3>
                            <p><strong>Priority:</strong> ${car.priority.toUpperCase()}</p>
                            <p><strong>SoC:</strong> ${car.start_soc}% &rarr; ${car.min_soc || 'N/A'}%</p>
                            <p><strong>Leave By:</strong> ${car.leave_by || 'Not specified'}</p>
                            <p class="option"><strong>Charging Plan:</strong> ${car.charging_option || 'Deciding...'}</p>
                            <p class="points"><strong>Loyalty Points:</strong> ${car.points_awarded || 0}</p>
                            <p><small>Request: "${car.original_text}"</small></p>
                        `;
                        queueDiv.appendChild(carDiv);
                    });
                }
            } catch (error) {
                console.error('Failed to fetch data:', error);
                document.getElementById('charging-queue').innerHTML = '<p>Error loading data. Is the orchestrator running?</p>';
            }
        }

        // Fetch data every 2 seconds
        setInterval(fetchData, 2000);
        // Initial fetch
        fetchData();
    </script>
</body>
</html>
